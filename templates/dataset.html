<html>
<head>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/3.3.7/css/bootstrap.min.css') }}" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u">

    <!-- Optional theme -->
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/3.3.7/css/bootstrap-theme.min.css') }}" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp">

    <!-- Latest compiled and minified JavaScript -->
    <script src="{{ url_for('static', filename='jquery/1.12.4/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap/3.3.7/js/bootstrap.min.js') }}" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"></script>
    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
</head>
<body>
<div class="container">
    <div class="row">
        {% if not dataset_id %}
            <div class="page-header">
                <h1>Select tweets in dataset</h1>
                <p class="help-block">Limit the tweets selected from the source datasets. Once completed, create the dataset.</p>
            </div>
        {% else %}
            <div class="page-header">
                <h1>Dataset</h1>
                <p class="help-block">The parameters are frozen. Choose a Dataset Actions to generate dataset derivatives.</p>
            </div>
        {% endif %}
    </div>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
                {% for message in messages %}
                    <div class="row">
                        <div class="alert alert-info" role="alert">{{ message }}</div>
                    </div>
                {% endfor %}
        {% endif %}
    {% endwith %}
    {% if dataset_id %}
        <div class="well well-sm">Link for this dataset: <a href="{{ request.url }}">{{ request.url }}</a></div>
    {% endif %}
    <nav class="navbar navbar-default navbar-static" id="navBar">
        <ul class="nav navbar-nav">
            {% if task_id %}
                <li><a href="#progress">Progress</a></li>
            {% endif %}
            <li><a href="#datasetParameters">Dataset parameters</a></li>
            <li><a href="#actions">Actions</a></li>
            <li><a href="#datasetStatistics">Dataset statistics</a></li>
            <li><a href="#sampleTweets">Sample tweets</a></li>
            {% if tweet_id_filenames %}
                <li><a href="#files">Files</a></li>
            {% endif %}
        </ul>
    </nav>
    {% if task_id %}
        <div class="row">
            <div class="panel panel-default" id="progress">
                <div class="panel-heading"><h2 class="panel-title">Progress generating dataset derivatives</h2></div>
                <div class="panel-body">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                        </div>
                    </div>
                    <p id="progressBarStatus" />
                    <script>
                        function update_progress() {
                            // send GET request to status URL
                            $.getJSON('/status/{{ task_id }}', function(data) {
                                // update UI
                                percent = parseInt(data['current'] * 100 / data['total']);
                                $('#progressBar').attr('aria-valuenow', percent);
                                $('#progressBar').text(percent + '%');
                                $('#progressBar').css('width', percent + '%');
                                $('#progressBarStatus').text(data['status']);
                                if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
                                    window.location.href='{{ url_for('dataset', dataset_id=dataset_id) }}';
                                }
                                else {
                                    // rerun in 2 seconds
                                    setTimeout(function() {
                                        update_progress();
                                    }, 2000);
                                }
                            });
                        }
                        $( document ).ready(function() {
                            update_progress();
                        });
                    </script>

                </div>
            </div>
        </div>
    {% endif %}
    <form class="form-horizontal" action="{{ url_for('limit_dataset') }}" method="POST">
        <div class="row">
            <div id="datasetParameters" class="panel panel-default">
                <div class="panel-heading"><h2 class="panel-title">Dataset parameters</h2></div>
                <div class="panel-body">
                    <div class="col-sm-offset-1">
                        <h4>Source datasets</h4>
                    </div>
                    <div class="form-group">
                        <div class="checkbox col-sm-offset-2">
                            {% for dataset in source_datasets %}
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox" name="limit_source_datasets" value="{{ dataset.meta.id }}" {% if dataset.meta.id in limit_source_datasets %}checked{% endif %}>
                                    {{ dataset.name }}
                                  </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-sm-offset-1">
                        <h4>Tweet text</h4>
                        <p class="help-block">For a retweet or quote, tweet text includes the text of the source tweet.</p>
                    </div>
                    <div class="form-group">
                        <label for="tweetTextContainsAll" class="col-sm-2 control-label">Contains all</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" rows="2" id="tweetTextContainsAll" name="limit_tweet_text_all">{{ limit_tweet_text_all }}</textarea>
                            <p class="help-block">Text must contain all of these terms (AND). Comma separate multiple terms. Space separated words are treated as a phrase.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tweetTextContainsAny" class="col-sm-2 control-label">Contains any</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" rows="2" id="tweetTextContainsAny" name="limit_tweet_text_any">{{ limit_tweet_text_any }}</textarea>
                            <p class="help-block">Text must contain one of these terms (OR). Comma separate multiple terms. Space separated words are treated as a phrase.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tweetTextExclude" class="col-sm-2 control-label">Excludes</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" rows="2" id="tweetTextExclude" name="limit_tweet_text_exclude">{{ limit_tweet_text_exclude }}</textarea>
                            <p class="help-block">Text may not contain (NOT). Comma separate multiple terms. Space separated words are treated as a phrase.</p>
                        </div>
                    </div>
                    <h4 class="col-sm-offset-1">Hashtags</h4>
                    <div class="form-group">
                        <label for="hashtagContainsAny" class="col-sm-2 control-label">Contains any</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" rows="2" id="hashtagContainsAny" name="limit_hashtag_any">{{ limit_hashtag_any }}</textarea>
                            <p class="help-block">Text must contain one of these hashtags (OR). # is optional. Case insensitive.</p>
                        </div>
                    </div>
                    <h4 class="col-sm-offset-1">Tweet types</h4>
                    <div class="form-group">
                        <div class="checkbox col-sm-offset-2">
                            <label>
                                <input type="checkbox" name="limit_tweet_type_original" value="true" {% if limit_tweet_type_original == 'true' %}checked{% endif %}>
                                    Original
                            </label>
                        </div>
                        <div class="checkbox col-sm-offset-2">
                            <label>
                                <input type="checkbox" name="limit_tweet_type_quote" value="true" {% if limit_tweet_type_quote == 'true' %}checked{% endif %}>
                                    Quote
                            </label>
                        </div>
                        <div class="checkbox col-sm-offset-2">
                            <label>
                                <input type="checkbox" name="limit_tweet_type_retweet" value="true" {% if limit_tweet_type_retweet == 'true' %}checked{% endif %}>
                                    Retweet
                            </label>
                        </div>
                        <div class="checkbox col-sm-offset-2">
                            <label>
                                <input type="checkbox" name="limit_tweet_type_reply" value="true" {% if limit_tweet_type_reply == 'true' %}checked{% endif %}>
                                    Reply
                            </label>
                        </div>

                    </div>
                    <h4 class="col-sm-offset-1">Other</h4>
                    <div class="form-group">
                        <label for="tweetLimit" class="col-sm-2 control-label">Limit</label>
                        <div class="col-sm-2">
                            <input type="number" class="form-control" id="tweetLimit" name="limit_tweet_limit" value="{{ limit_tweet_limit }}" min="1">
                            <p class="help-block">Maximum number of tweets to include in dataset.</p>
                        </div>
                    </div>
                    <p>TODO:
                        <ul>
                    <li>Mentions userids</li>
                    <li>Mentions screen names</li>
                    <li>Which users</li>
                    <li>User is verified</li>
                    <li>Date range</li>
                    <li>Has media</li>
                    <li>Has URL</li>
                    <li>Is geotagged</li>

                </ul>
                    </p>
                </div>
            </div>
        </div>
        <div class="row">
            <div id="actions" class="panel panel-default">
                <div class="panel-heading"><h2 class="panel-title">Actions</h2></div>
                <div class="panel-body">
                    <div class="form-group">
                        <div class="col-sm-offset-2">
                            {% if not dataset_id %}
                                <button type="submit" class="btn btn-default">Preview</button>
                                <p class="help-block">Get a sample of tweets in the dataset and see dataset statistics.</p>
                                <button type="submit" name="create" value="true" class="btn btn-default">Create dataset</button>
                                <p class="help-block">Freeze the dataset parameters to allow generating dataset derivatives.</p>
                            {% else %}
                                {% if not task_id and not tweet_id_filenames %}
                                    <a class="btn btn-default" href="{{ url_for('dataset', dataset_id=dataset_id, generate_tweet_ids='true') }}">Generate tweet ids</a>
                                    <p class="help-block">Generate files containing the tweet ids of the dataset.</p>
                                {% endif %}
                                <button type="submit" class="btn btn-default">Preview new dataset</button>
                                <p class="help-block">Return to limiting the tweets in the dataset using the dataset parameters.</p>
                            {% endif %}
                            <a href="{{ url_for('dataset_list') }}" class="btn btn-default">Start over</a>
                            <p class="help-block">Return to selecting source datasets.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script>
        var checkboxes = $("input[name='limit_source_datasets']");
        var submitBtn = $("button[type='submit']");

        checkboxes.click(function() {
            submitBtn.attr("disabled", !checkboxes.is(":checked"));
        });
    </script>

    <div class="row">
        <div class="panel panel-default" id="datasetStatistics">
            <div class="panel-heading"><h2 class="panel-title">Dataset statistics</h2></div>
            <div class="panel-body">
                <h4>Tweet count</h4>
                <p>{{ total_tweets }}</p>
                <div class="row">
                    <div class="col-md-4">
                        <h4>Tweet type</h4>
                        <ul class="list-group">
                            {% for tweet_type in tweet_types %}
                                <li class="list-group-item">
                                    <span class="badge">{{ tweet_type.doc_count }} ({{ '{:.0%}'.format(tweet_type.doc_count / total_tweets) }})</span>
                                    {{ tweet_type.key }}
                                </li>
                            {% endfor %}
                        </ul>
                        <h4>Top users</h4>
                        <ul class="list-group">
                            {% for user in top_users %}
                                <li class="list-group-item">
                                    <span class="badge">{{ user.doc_count }}</span>
                                    <a href="https://twitter.com/{{ user.key }}" target="_blank">@{{ user.key }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                        <h4>Top mentions</h4>
                        <ul class="list-group">
                            {% for user in top_mentions %}
                                <li class="list-group-item">
                                    <span class="badge">{{ user.doc_count }}</span>
                                    <a href="https://twitter.com/{{ user.key }}" target="_blank">@{{ user.key }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                        <h4>Top hashtags</h4>
                        <ul class="list-group">
                            {% for hashtag in top_hashtags %}
                                <li class="list-group-item">
                                    <span class="badge">{{ hashtag.doc_count }}</span>
                                    #{{ hashtag.key }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <p>TODO:
                <ul>
                    <li>Tweet type percentage</li>
                    <li>Date range. Histogram?</li>
                    <li>Top urls</li>
            </ul></p>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="panel panel-default" id="sampleTweets">
            <div class="panel-heading"><h2 class="panel-title">Sample tweets from dataset</h2></div>
            <div class="panel-body">
                {% if sample_tweet_html %}
                    {% for tweet_html in sample_tweet_html %}
                        {{ tweet_html | safe }}
                    {% endfor %}
                {% elif sample_tweet_ids %}
                    <ul>
                        {% for tweet_id in sample_tweet_ids %}
                            <li><a href="https://twitter.com/_/status/{{ tweet_id }}" target="_blank">{{ tweet_id }}</a></li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>
    </div>
    {% if tweet_id_filenames %}
        <div class="row">
            <div class="panel panel-default" id="files">
                <div class="panel-heading"><h2 class="panel-title">Generated tweet id files</h2></div>
                <div class="panel-body">
                    <ul class="list-group">
                    {% for filename in tweet_id_filenames %}
                        <li class="list-group-item"><a href="{{ url_for('dataset_file', dataset_id=dataset_id, filename=filename) }}">{{ filename }}</a></li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    {% endif %}

    Top retweets and download
    Top mentions and download
            Top hashtags and download
            Top URLs and download. Download all URLs?
            Links to download tweet ids
            Curl or similar to download tweet ids
            Mention node and edges
            Reply node and edges
            Hashtag node and edges

</div>
</body>
</html>
