{% extends "base.html" %}
{% block script %}
<script>
    var options = {changeMonth: true,
                    changeYear: true,
                    dateFormat: "yy-mm-dd",
                    minDate:  "{{dataset_created_at_min.strftime('%Y-%m-%d')}}",
                    maxDate: "{{dataset_created_at_max.strftime('%Y-%m-%d')}}"};
    $( function() {
      $( "#created_at_from" ).datepicker(options);
      $( "#created_at_to" ).datepicker(options);
    } );

    function toCSV(data, filename) {
        /* Create CSV from JSON. From https://stackoverflow.com/questions/16078544/export-to-csv-using-jquery-and-html */
        let csv = Papa.unparse(data);
        // Check for HTML5 methods
        if (window.Blob && window.URL) {
            // HTML5 Blob        
            let blob = new Blob([csv], {
                type: 'text/csv;charset=utf-8'
            });
            let csvUrl = URL.createObjectURL(blob);

            $(this)
                .attr({
                    'download': filename,
                    'href': csvUrl
            });
        } else {
            // Fall-back method: data URI
            let csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

          $(this)
             .attr({
                'download': filename,
                'href': csvData,
                'target': '_blank'
            });
        }
    }
</script>
{% endblock %}
{% block body %}
<div class="container">
    <div class="row">
        <div class="page-header">
            {% if prev_datasets %}
                    <div class="dropdown pull-right">
                        <button class="btn btn-default dropdown-toggle" type="button" id="prevDatasetDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            Previous datasets
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="prevDatasetDropdown">
                            {% for prev_dataset in prev_datasets %}
                                <li><a href="{{ url_for('dataset', dataset_id=prev_dataset['dataset_id']) }}">{{ prev_dataset['dataset_name'] }} ({{ prev_dataset['create_date']}})</a></li>
                            {% endfor %}
                            <li role="separator" class="divider"></li>
                            <li><a id="clearPrevDatasets" href="#">Clear previous datasets</a></li>
                        </ul>
                    </div>
                    <script>
                        $('#clearPrevDatasets').click(function(e) {
                            e.preventDefault();
                            Cookies.remove('prev_datasets');
                            $('#prevDatasetDropdown').addClass('hidden');
                        });
                    </script>
            {% endif %}
            {% if not dataset_id %}
                <h1>Select tweets in dataset</h1>
                <p class="help-block">Limit the tweets selected from the source datasets. Once completed, create the dataset.</p>
            {% else %}
                <h1>Dataset: {{ dataset_name }}</h1>
                <p class="help-block">The parameters are frozen. Generate and download dataset exports.</p>
            {% endif %}
        </div>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
                {% for category, message in messages %}
                    <div class="row">
                        <div class="alert {% if category != 'message' %} alert-{{category}} {% else %} alert-info {% endif %}" role="status">{{ message | safe }}</div>
                    </div>
                {% endfor %}
        {% endif %}
    {% endwith %}
    {% if dataset_id %}
        <div class="well well-sm">Link for this dataset: <a href="{{ request.base_url }}">{{ request.base_url }}</a></div>
    {% endif %}


    <div class="row">
        <ul class="nav nav-pills" role="tablist" id="navBar">
            <li role="presentation" class="active"><a href="#datasetParametersActions" aria-controls="datasetParametersActions" role="tab" data-toggle="tab" id="datasetParametersActionsTab">Dataset parameters / actions</a></li>
            <li role="presentation"><a href="#datasetStatistics" aria-controls="datasetStatistics" role="tab" data-toggle="tab" id="datasetStatisticsTab">Dataset statistics</a></li>
            <li role="presentation"><a href="#sampleTweets" aria-controls="sampleTweets" role="tab" data-toggle="tab" id="sampleTweetsTab">Sample tweets</a></li>
            <li role="presentation"><a href="#sourceDatasets" aria-controls="sourceDatasets" role="tab" data-toggle="tab" id="sourceDatasetsTab">Source datasets</a></li>
            {% if dataset_id %}
                <li role="presentation"><a href="#datasetExports" aria-controls="datasetExports" role="tab" data-toggle="tab" id="datasetExportsTab">Dataset exports</a></li>
            {% endif %}
        </ul>
    </div>
    <br />
    <div class="row">
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="datasetParametersActions">
                <form id="limitForm" class="form-horizontal" action="{{ url_for('limit_dataset') }}#datasetStatistics" method="POST">
                    <div class="row">
                        <div id="datasetParameters" class="panel panel-default">
                            <div class="panel-heading"><h2 class="panel-title">Dataset parameters</h2></div>
                            <div class="panel-body">
                                <div class="col-sm-offset-1">
                                    <h4>Source datasets</h4>
                                </div>
                                <div class="form-group">
                                    <div class="checkbox col-sm-offset-2">
                                        {% for dataset in source_datasets %}
                                            <div class="checkbox">
                                              <label>
                                                <input type="checkbox" name="limit_source_datasets" value="{{ dataset.meta.id }}" {% if dataset.meta.id in limit_source_datasets %}checked{% endif %}>
                                                {{ dataset.name }}
                                              </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-sm-offset-1">
                                    <h4>Tweet text</h4>
                                    <p class="help-block">For a retweet or quote, tweet text includes the text of the source tweet.</p>
                                </div>
                                <div class="form-group">
                                    <label for="tweetTextContainsAll" class="col-sm-2 control-label">Contains all</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="tweetTextContainsAll" name="limit_tweet_text_all">{{ limit_tweet_text_all }}</textarea>
                                        <p class="help-block">Text must contain all of these terms (AND). Comma separate multiple terms. Space separated words are treated as a phrase.</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="tweetTextContainsAny" class="col-sm-2 control-label">Contains any</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="tweetTextContainsAny" name="limit_tweet_text_any">{{ limit_tweet_text_any }}</textarea>
                                        <p class="help-block">Text must contain one of these terms (OR). Comma separate multiple terms. Space separated words are treated as a phrase.</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="tweetTextExclude" class="col-sm-2 control-label">Excludes</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="tweetTextExclude" name="limit_tweet_text_exclude">{{ limit_tweet_text_exclude }}</textarea>
                                        <p class="help-block">Text may not contain (NOT). Comma separate multiple terms. Space separated words are treated as a phrase.</p>
                                    </div>
                                </div>
                                <h4 class="col-sm-offset-1">Hashtags</h4>
                                <div class="form-group">
                                    <label for="hashtagContainsAny" class="col-sm-2 control-label">Contains any</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="hashtagContainsAny" name="limit_hashtag_any">{{ limit_hashtag_any }}</textarea>
                                        <p class="help-block">Text must contain one of these hashtags (OR). # is optional. Case insensitive.</p>
                                    </div>
                                </div>
                                <h4 class="col-sm-offset-1">Mentions</h4>
                                <div class="form-group">
                                    <label for="mentionContainsAny" class="col-sm-2 control-label">Contains any</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="mentionContainsAny" name="limit_mention_any">{{ limit_mention_any }}</textarea>
                                        <p class="help-block">Any of these screen names must be mentioned (OR). @ is optional. Case sensitive.</p>
                                    </div>
                                </div>
                                <h4 class="col-sm-offset-1">Posted by</h4>
                                <div class="form-group">
                                    <label for="posterContainsAny" class="col-sm-2 control-label">Poster screen names</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="posterContainsAny" name="limit_poster_any">{{ limit_poster_any }}</textarea>
                                        <p class="help-block">Tweets posted by any of these screen names (OR). @ is optional. Case sensitive.</p>
                                            <input type="checkbox" id="limit_poster_retweets_also" name="limit_poster_retweets_also" value="true" {% if limit_poster_retweets_also == 'true' %}checked{% endif %}>
                                            <label for="limit_poster_retweets_also">Include retweets or quotes of posts by these screen names.</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="posterUserIdContainsAny" class="col-sm-2 control-label">Poster user ids</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="posterUserIdContainsAny" name="limit_poster_user_id_any">{{ limit_poster_user_id_any }}</textarea>
                                        <p class="help-block">Tweets posted by any of these user ids (OR).</p>
                                            <input type="checkbox" id="limit_poster_user_id_retweets_also" name="limit_poster_user_id_retweets_also" value="true" {% if limit_poster_user_id_retweets_also == 'true' %}checked{% endif %}>
                                            <label for="limit_poster_user_id_retweets_also">Include retweets or quotes of these user ids.</label>
                                    </div>
                                </div>
                                <h4 class="col-sm-offset-1">In reply to</h4>
                                <div class="form-group">
                                    <label for="inReplyToContainsAny" class="col-sm-2 control-label">Contains any screen name</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="inReplyToContainsAny" name="limit_in_reply_to_any">{{ limit_in_reply_to_any }}</textarea>
                                        <p class="help-block">Tweets in reply to these screen names (OR). @ is optional. Case sensitive.</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inReplyToUserIdContainsAny" class="col-sm-2 control-label">Contains any user id</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="inReplyToUserIdContainsAny" name="limit_in_reply_to_user_id_any">{{ limit_in_reply_to_user_id_any }}</textarea>
                                        <p class="help-block">Tweet in reply to these user ids (OR).</p>
                                    </div>
                                </div>
                                <h4 class="col-sm-offset-1">Tweet types</h4>
                                <div class="form-group">
                                    <div class="checkbox col-sm-offset-2">
                                        <label>
                                            <input type="checkbox" name="limit_tweet_type_original" value="true" {% if limit_tweet_type_original == 'true' %}checked{% endif %}>
                                                Original
                                        </label>
                                    </div>
                                    <div class="checkbox col-sm-offset-2">
                                        <label>
                                            <input type="checkbox" name="limit_tweet_type_quote" value="true" {% if limit_tweet_type_quote == 'true' %}checked{% endif %}>
                                                Quote
                                        </label>
                                    </div>
                                    <div class="checkbox col-sm-offset-2">
                                        <label>
                                            <input type="checkbox" name="limit_tweet_type_retweet" value="true" {% if limit_tweet_type_retweet == 'true' %}checked{% endif %}>
                                                Retweet
                                        </label>
                                    </div>
                                    <div class="checkbox col-sm-offset-2">
                                        <label>
                                            <input type="checkbox" name="limit_tweet_type_reply" value="true" {% if limit_tweet_type_reply == 'true' %}checked{% endif %}>
                                                Reply
                                        </label>
                                    </div>

                                </div>
                                <h4 class="col-sm-offset-1">Created at</h4>
                                <div class="form-group">
                                    <label for="created_at_from" class="col-sm-2 control-label">From<span class="sr-only">, format as 4 digit year hyphen 2 digit month hyphen 2 digit day</span></label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" id="created_at_from" name="limit_created_at_from" value="{{ limit_created_at_from }}" pattern="[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}">
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="help-block">Created at date is greater than or equal to.{% if created_at_min %} First tweet in limited dataset is {{ created_at_min.strftime('%Y-%m-%d') }}.{% endif %}{% if dataset_created_at_min %} First tweet in source dataset(s) is {{ dataset_created_at_min.strftime('%Y-%m-%d') }}.{% endif %}</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="created_at_to" class="col-sm-2 control-label">To<span class="sr-only">, format as 4 digit year hyphen 2 digit month hyphen 2 digit day</span></label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" id="created_at_to" name="limit_created_at_to" value="{{ limit_created_at_to }}" pattern="[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}">
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="help-block">Created at date is less than or equal to.{% if created_at_max %} Last tweet in limited dataset is {{ created_at_max.strftime('%Y-%m-%d') }}.{% endif %}{% if dataset_created_at_max %} Last tweet in source dataset(s) is {{ dataset_created_at_max.strftime('%Y-%m-%d') }}.{% endif %}</p>
                                    </div>
                                </div>
                                <h4 class="col-sm-offset-1">Entities</h4>
                                <div class="form-group">
                                    <div class="checkbox col-sm-offset-2">
                                        <label>
                                            <input type="checkbox" name="limit_has_media" value="true" {% if limit_has_media == 'true' %}checked{% endif %}>
                                                Tweet has at least one media (embedded images)
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="checkbox col-sm-offset-2">
                                        <label>
                                            <input type="checkbox" name="limit_has_url" value="true" {% if limit_has_url == 'true' %}checked{% endif %}>
                                                Tweet includes at least one URL
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="urlAny" class="col-sm-2 control-label">Contains any URL</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="2" id="urlAny" name="limit_url_any">{{ limit_url_any }}</textarea>
                                        <p class="help-block">Tweet must contain a URL that starts with one of these URL fragments (OR). For example, "https://twitter.com/" will match "https://twitter.com/gelmanlibrary". Case insensitive.</p>
                                    </div>
                                </div>
                                <h4 class="col-sm-offset-1">Other</h4>
                                <div class="form-group">
                                    <div class="checkbox col-sm-offset-2">
                                        <label>
                                            <input type="checkbox" name="limit_has_geo" value="true" {% if limit_has_geo == 'true' %}checked{% endif %}>
                                                Tweet is geotagged
                                        </label>
                                        <p class="help-block">Tweet has a value for geo, coordinates, or place.</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="tweetLimit" class="col-sm-2 control-label">Limit</label>
                                    <div class="col-sm-2">
                                        <input type="number" class="form-control" id="tweetLimit" name="limit_tweet_limit" value="{{ limit_tweet_limit }}" min="1">
                                    </div>
                                    <div class="col-sm-7">
                                        <p class="help-block">Maximum number of tweets to include in dataset.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div id="actions" class="panel panel-default">
                            <div class="panel-heading"><h2 class="panel-title">Actions</h2></div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <div class="col-sm-offset-1">
                                        {% if not dataset_id %}
                                            <button type="submit" class="btn btn-primary">Preview</button>
                                            <p class="help-block">Get a sample of tweets in the dataset and see dataset statistics.</p>
                                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#datasetNameModal">Create dataset</button>
                                            <p class="help-block">Freeze the dataset parameters to allow generating dataset exports.</p>
                                            <input type="hidden"  name="dataset_name" value="" />

                                        {% else %}
                                            <button type="submit" class="btn btn-primary">Preview new dataset</button>
                                            <p class="help-block">Return to limiting the tweets in the dataset using the dataset parameters.</p>
                                        {% endif %}
                                        <a href="{{ url_for('dataset_list') }}" class="btn btn-default">Start over</a>
                                        <p class="help-block">Return to selecting source datasets.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <script>
                $(function() {
                    var checkboxes = $("input[name='limit_source_datasets']");
                    var submitBtn = $("button[type='submit']");

                    checkboxes.click(function() {
                        submitBtn.attr("disabled", !checkboxes.is(":checked"));
                    });

                    $('#createModalSubmit').click(function() {
                        $("input[name='dataset_name']" ).val($("input[name='dataset_name_modal']").val());
                        $("#limitForm").submit();
                    });

                    $('#datasetNameModalForm').submit(function( event ) {
                        event.preventDefault();
                            $("input[name='dataset_name']" ).val($("input[name='dataset_name_modal']").val());
                            $("#limitForm").submit();
                    });
                });
                </script>
            </div>
            <div role="tabpanel" class="tab-pane" id="datasetStatistics">
                <div class="row">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h2 class="panel-title">Dataset statistics</h2></div>
                        <div class="panel-body" id="stats-panel">
                            <h4>Tweet count</h4>
                            <p>{{ total_tweets | nf }}</p>
                            {% if total_tweets %}
                                <h4>First tweet</h4>
                                <p>{{ created_at_min }}</p>
                                <h4>Last tweet</h4>
                                <p>{{ created_at_max }}</p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <h4>Tweet type</h4>
                                        <ul class="list-group">
                                            {% for tweet_type in tweet_types %}
                                                <li class="list-group-item">
                                                    <span class="badge">{{ tweet_type.doc_count | nf }} ({{ '{:.0%}'.format(tweet_type.doc_count / total_tweets) }})</span>
                                                    {{ tweet_type.key }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        <a id="top_users" class="csv_download_link pull-right" href="#">Download top {{ top_users|length }} users</a>
                                        <h4>Top users</h4>
                                        <ul class="list-group">
                                            {% for user in top_users[:max_rows] %}
                                                <li class="list-group-item">
                                                    <span class="badge">{{ user.doc_count | nf }}</span>
                                                    <a href="https://twitter.com/{{ user.key }}" target="_blank">@{{ user.key }}</a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        <a id="top_mentions" class="csv_download_link pull-right" href="#">Download top {{ top_mentions|length }} mentions</a>
                                        <h4>Top mentions</h4>
                                        <ul class="list-group">
                                            {% for user in top_mentions[:max_rows] %}
                                                <li class="list-group-item">
                                                    <span class="badge">{{ user.doc_count | nf }}</span>
                                                    <a href="https://twitter.com/{{ user.key }}" target="_blank">@{{ user.key }}</a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        <a id="top_hashtags" class="csv_download_link pull-right" href="#">Download top {{ top_hashtags|length }} hashtags</a>
                                        <h4>Top hashtags</h4>
                                        <ul class="list-group">
                                            {% for hashtag in top_hashtags[:max_rows] %}
                                                <li class="list-group-item">
                                                    <span class="badge">{{ hashtag.doc_count | nf }}</span>
                                                    #{{ hashtag.key }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                <a id="top_urls" class="csv_download_link pull-right" href="#">Download top {{ top_urls|length }} urls</a>
                                <h4>Top URLs</h4>
                                <ul class="list-group">
                                    {% for url in top_urls[:max_rows] %}
                                        <li class="list-group-item">
                                            <span class="badge">{{ url.doc_count | nf }}</span>
                                            <a href="{{ url.key }}">{{ url.key }}</a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <form class="form-horizontal" action="{{ url_for('limit_dataset') }}#datasetExports" method="POST">
                    <div class="row">
                        <div class="panel panel-default">
                            <div class="panel-heading"><h2 class="panel-title">Actions</h2></div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <div class="col-sm-offset-1">
                                        {% if not dataset_id %}
                                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#datasetNameModal">Create dataset</button>
                                            <p class="help-block">Freeze the dataset parameters to allow generating dataset exports.</p>
                                            <input type="hidden"  name="dataset_name" value="" />
                                        {% endif %}
                                        <a href="{{ url_for('dataset_list') }}" class="btn btn-default">Start over</a>
                                        <p class="help-block">Return to selecting source datasets.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div role="tabpanel" class="tab-pane" id="sampleTweets">
                <div class="row">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h2 class="panel-title">Sample tweets from dataset</h2></div>
                        <div class="panel-body">
                            {% if sample_tweet_html %}
                                {% for tweet_html in sample_tweet_html %}
                                    {{ tweet_html | safe }}
                                {% endfor %}
                            {% elif sample_tweet_ids %}
                                <ul>
                                    {% for tweet_id in sample_tweet_ids %}
                                        <li><a href="https://twitter.com/_/status/{{ tweet_id }}" target="_blank">{{ tweet_id }}</a></li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <form class="form-horizontal" action="{{ url_for('limit_dataset') }}#datasetExports" method="POST">
                    <div class="row">
                        <div class="panel panel-default">
                            <div class="panel-heading"><h2 class="panel-title">Actions</h2></div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <div class="col-sm-offset-1">
                                        {% if not dataset_id %}
                                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#datasetNameModal">Create dataset</button>
                                            <p class="help-block">Freeze the dataset parameters to allow generating dataset exports.</p>
                                            <input type="hidden"  name="dataset_name" value="" />
                                        {% endif %}
                                        <a href="{{ url_for('dataset_list') }}" class="btn btn-default">Start over</a>
                                        <p class="help-block">Return to selecting source datasets.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div role="tabpanel" class="tab-pane" id="sourceDatasets">
                <div class="row">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h2 class="panel-title">Source datasets</h2></div>
                        <div class="panel-body">
                            {% for dataset in source_datasets %}
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="heading{{ dataset.meta.id }}">
                                        <h4 class="panel-title">{{ dataset.name }}</h4>
                                    </div>
                                    <div class="panel-body">
                                        {% include 'source_dataset_snippet.html' %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% if dataset_id %}
                <div role="tabpanel" class="tab-pane" id="datasetExports">
                    {% if task_id %}
                        <script>
                                function update_progress(url, progressBar, progressBarStatus) {
                                    // send GET request to status URL
                                    $.getJSON(url, function(data) {
                                        // update UI
                                        percent = parseInt(data['current'] * 100 / data['total']);
                                        progressBar.attr('aria-valuenow', percent);
                                        progressBar.text(percent + '%');
                                        progressBar.css('width', percent + '%');
                                        progressBarStatus.text(data['status']);
                                        if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
                                            window.location.hash = 'datasetExports';
                                            window.location.href='{{ url_for("dataset", dataset_id=dataset_id) }}#datasetExports';
                                        }
                                        else {
                                            window.location.hash = 'datasetExports';
                                            window.location.href='{{ url_for("dataset", dataset_id=dataset_id) }}?reload=true#datasetExports';
                                            // rerun in 2 seconds
                                            setTimeout(function() {
                                                update_progress(url, progressBar, progressBarStatus);
                                            }, 2000);
                                            }
                                    });
                                }
                        </script>

                        <div class="row">
                            <div class="panel panel-default">
                                <div class="panel-heading"><h2 class="panel-title">Progress generating dataset exports</h2></div>
                                <div class="panel-body">
                                    {% if task_id %}
                                        <h3>Tasks</h3>
                                        <div class="progress">
                                            <div id="progressBarTask" class="progress-bar" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                            </div>
                                        </div>
                                        <p id="progressBarStatusTask" />
                                        <script>
                                            $( document ).ready(function() {
                                                update_progress('/status/{{ task_id }}', $('#progressBarTask'), $('#progressBarStatusTask'));
                                            });
                                        </script>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    {% for label, filenames in filenames_list %}
                        <div class="row">
                            <div class="panel panel-default">
                                <div class="panel-heading"><h2 class="panel-title">{{ label }}</h2></div>
                                <div class="panel-body">
                                    <ul class="list-group">
                                    {% for filename in filenames %}
                                        <li class="list-group-item"><a href="{{ url_for('dataset_file', dataset_id=dataset_id, filename=filename) }}">{{ filename }}</a></li>
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    {% if filenames_list %}
                    <p class="text-info">Tip: See the public link(s) on the Source datasources tab for citing these dataset(s).</p>
                    {% endif %}
                    <div class="row">
                        <div id="datasetExportsActions" class="panel panel-default">
                            <div class="panel-heading"><h2 class="panel-title">Generate Export Actions</h2></div>
                            <div class="panel-body">
                                {% if total_tweets > 0 %}
                                <form id="datasetExportsForm" class="form-horizontal" action="{{ url_for('dataset', dataset_id=dataset_id) }}" method="POST">
                                    {% if is_local_mode %}
                                       <div class="checkbox">
                                          <label>
                                            <input type="checkbox" name="generate_tweet_json" value="true">
                                            Generate tweet JSON
                                              <p class="help-block">Generate files containing the tweet JSON of the dataset.</p>
                                          </label>
                                        </div>
                                       <div class="checkbox">
                                          <label>
                                            <input type="checkbox" name="generate_tweet_csv" value="true">
                                            Generate tweet CSV
                                              <p class="help-block">Generate files containing tweet text and select metadata in CSV (can be used with Excel).</p>
                                          </label>
                                        </div>
                                    {% endif %}
                                    <div class="checkbox">
                                      <label>
                                        <input type="checkbox" name="generate_tweet_ids" value="true">
                                        Generate tweet ids
                                          <p class="help-block">Generate files containing the tweet ids of the dataset.</p>
                                      </label>
                                    </div>
<<<<<<< HEAD
                                     <button type="submit" name="generate_tasks" value="true" class="btn btn-primary" {% if task_id %} disabled="true" {% endif %}>Generate</button>
=======
                                    <div class="checkbox">
                                        <label>
                                        <input type="checkbox" name="generate_mentions" value="true">
                                        Generate mentions
                                          <p class="help-block">Generate files containing a mapping of user id to mentioned user id (edges) and user ids to screen names (nodes).</p>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                        <input type="checkbox" name="generate_top_mentions" value="true">
                                        Generate top mentions
                                          <p class="help-block">Generate files containing an ordered count of mentioned user ids and screen names.</p>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                        <input type="checkbox" name="generate_top_users" value="true">
                                        Generate top users
                                          <p class="help-block">Generate files containing an ordered count of tweets by user ids and screen names.</p>
                                        </label>
                                    </div>
                                    <button type="submit" form="datasetExportsForm" name="generate_tasks" value="true" class="btn btn-primary" {% if task_id %} disabled="true" {% endif %}>Generate</button>
>>>>>>> Fixes #91. Remediates accessibility issues.
                                </form>
                                {% else %}
                                <div class="alert alert-warning" role="alert" atomic-live="true">No tweets found, refine the dataset parameters to generate an export.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                </div>
            {% endif %}
        </div>
    </div>
    <script>
        $(function() {
            $('#navBar a').click(function(e) {
              e.preventDefault();
              $(this).tab('show');
            });

            // on load of the page: switch to the currently selected tab
            var hash = window.location.hash;
            $(hash + 'Tab').click();
        });
    </script>
</div>


<!-- Dataset name modal -->
<div class="modal fade" id="datasetNameModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="false">
                &times;
                </button>
               <h3 class="modal-title" id="myModalLabel">Dataset name</h3>
            </div>
            <div class="modal-body">
                <form name="modal-form" class="form-horizontal" id="datasetNameModalForm">
                    <label for="dataset_name_modal">Provide a name for the dataset</label> 
                    <input class="form-control" type="text" id="dataset_name_modal" name="dataset_name_modal" value="" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                Close
                </button>
                <button type="submit" form="datasetNameModalForm" class="btn btn-primary" id="createModalSubmit" data-dismiss="modal">
                Create dataset
                </button>
            </div>
        </div>
    </div>
</div>
<script>
        /* Bind data for top stats to an element for retrieval when CSV reequested. */
        $("#stats-panel").data({"top_users": {{ top_users|tojson|safe }},
                                "top_mentions": {{ top_mentions|tojson|safe }},
                                "top_hashtags": {{ top_hashtags|tojson|safe }},
                                "top_urls": {{ top_urls|tojson|safe }}
                                });
        $(".csv_download_link").on("click", function(e) {
            /* Get the ID of the target clicked.*/
            let link_id = $(e.target).attr("id");
            /* Prevent click propagation. */
            e.stopPropagation();
            /* Get data associated with this id. */
            let data = $("#stats-panel").data(link_id);
            /* Call toCSV() on this element. */
            toCSV.apply(this, [data, link_id + ".csv"]);
        });
</script>
{% endblock %}
